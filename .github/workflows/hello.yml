name: Hello World

on:
  push:
    branches: [ "main" ]

jobs:
  hello:
    runs-on: self-hosted
    steps:    
      - name: Checkout repository
        uses: actions/checkout@v4

      
      - name: Print Hello
        run: echo "Hello World from GitHub Actions Runner!"

      - name: Build Docker image
        run: |
          docker build . \
            --file Dockerfile \
            --tag simplebankingsystem:latest \
            --tag simplebankingsystem:$(date +%s)

      
      - name: Run Docker Hello World
        run: docker run hello-world
        
      - name: Stop and remove old container if exists
        run: |
          if [ "$(docker ps -aq -f name=simplebankingsystem)" ]; then
            echo "Stopping old container..."
            docker stop simplebankingsystem || true
            echo "Removing old container..."
            docker rm simplebankingsystem || true
          fi
      
      - name: Run Docker Simple Banking System
        run: |
          docker run -d \
            --name simplebankingsystem \
            --restart unless-stopped \
            --network host \
            -p 8080:8080 \
            simplebankingsystem:latest
      
      - name: Run integration tests inside container
        run: |
          docker cp ./scripts/integration_test.sh simplebankingsystem:/integration_test.sh
          docker exec simplebankingsystem chmod +x /integration_test.sh
          docker exec simplebankingsystem /integration_test.sh          
            

      
      - name: Tag Docker image
        run: docker tag simplebankingsystem:latest 10.0.40.193:5000/team191/simplebankingsystem:latest

      - name: Push Docker image
        run: docker push 10.0.40.193:5000/team191/simplebankingsystem:latest

      - name: Build build‑stage image
        run: docker build . --target build -t simplebankingsystem-build
      
      - name: Extract compiled classes
        run: |
          container_id=$(docker create simplebankingsystem-build)
          mkdir -p target
          docker cp "$container_id":/app/target/classes ./target/classes
          docker rm "$container_id"


      - name: Run SonarQube analysis inside sonar image
        run: |
          docker run --rm \
            -e SONAR_HOST_URL=http://10.0.40.193:9000/ \
            -e SONAR_TOKEN=sqp_e21c5018f36294766e460f3e4f4891c1d12f1f97 \
            -v $(pwd):/usr/src \
            sonarsource/sonar-scanner-cli:latest \
              -Dsonar.projectKey=simplebankingsystem \
              -Dsonar.sources=. \
              -Dsonar.java.binaries=target/classes \
              -Dsonar.host.url=http://10.0.40.193:9000/ \
              -Dsonar.login=sqp_e21c5018f36294766e460f3e4f4891c1d12f1f97

        
      # --- DOKU: Site bauen (MkDocs) ---
      - name: Build docs site (MkDocs)
        run: |
          # MkDocs-Builder: Arbeitsdir /docs. Wir wollen Output ins Unterverzeichnis docs/site
          docker run --rm \
            -v "$(pwd)":/docs \
            -w /docs \
            squidfunk/mkdocs-material:latest \
            build -d site
      
      # --- DOKU: PDF bauen (Pandoc + XeLaTeX) ---
      - name: Build docs PDF (Pandoc)
        run: |
          # Pandoc-Container nutzt /data als Arbeitsverzeichnis. Erzeuge PDF aus deiner Hauptdatei.
          docker run --rm \
            -v "$(pwd)":/data \
            -w /data \
            pandoc/latex:3.1 \
            --toc --pdf-engine=xelatex -f markdown+grid_tables+table_captions \
            -o docs/Dokumentation.pdf docs/doc.md
      
      # --- DOKU: Smoke-Test (stellen wir sicher, dass Artefakte da sind) ---
      - name: Check docs artifacts
        run: |
          test -f docs/site/index.html
          test -f docs/Dokumentation.pdf
          echo "Docs site and PDF present."
      
      # --- DOKU: Runtime-Image (NGINX) bauen und pushen ---
      - name: Build documentation runtime image
        run: |
          DOC_IMG=10.0.40.193:5000/team191/simplebankingsystem-docs
          DOC_TAG="${GITHUB_REF_NAME//\//-}-${GITHUB_RUN_NUMBER}"
      
          cat > Dockerfile.docs-runtime <<'EOF'
          FROM nginx:alpine
          # Statisches Site-Bundle
          COPY docs/site/ /usr/share/nginx/html/
          # PDF zusätzlich im Root verfügbar machen
          COPY docs/Dokumentation.pdf /usr/share/nginx/html/
          # Optional: einfache Cache-Header oder Index lassen wir NGINX default.
          EOF
      
          docker build \
            -f Dockerfile.docs-runtime \
            -t ${DOC_IMG}:latest \
            -t ${DOC_IMG}:${DOC_TAG} \
            .
      
      - name: Push documentation runtime image
        run: |
          DOC_IMG=10.0.40.193:5000/team191/simplebankingsystem-docs
          DOC_TAG="${GITHUB_REF_NAME//\//-}-${GITHUB_RUN_NUMBER}"
          docker push ${DOC_IMG}:latest
          docker push ${DOC_IMG}:${DOC_TAG}
      
      # --- DOKU: PDF als Pipeline-Artefakt bereitstellen (optional, sehr praktisch) ---
      - name: Upload Dokumentation.pdf
        uses: actions/upload-artifact@v4
        with:
          name: Dokumentation.pdf
          path: docs/Dokumentation.pdf
